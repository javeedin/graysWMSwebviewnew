<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS - Trip Management</title>
    <!-- Prevent aggressive caching in WebView2 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.6/css/dx.light.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Dynamic cache busting - generate unique timestamp
        window.APP_CACHE_BUSTER = Date.now();
        console.log('[Cache Buster] Timestamp generated:', window.APP_CACHE_BUSTER);
    </script>
    <script src="https://cdn3.devexpress.com/jslib/23.2.6/js/dx.all.js"></script>
    <script>
        // DevExpress License Configuration - AFTER library loads
        // Account: jshaik@grays.mu
        DevExpress.config({
            licenseKey: "ewogICJmb3JtYXQiOiAxLAogICJjdXN0b21lcklkIjogImVlOWVhYTEwLTlkN2QtNGY5OS04YWM1LTdjZmI0ZDA1NWYwZCIsCiAgIm1heFZlcnNpb25BbGxvd2VkIjogMjMyCn0=.Vea066tbF42irVJqwpiFoZQvJi9X4UgfbFNGbmIgqrDv54JlxP+P4/WSJjiy5XpZkqTTbhMRnin//dl0sg1K5kCGOE3XquKboK++pqSbJ+vG7jzjJpfnx8BY10M28dh9iO7Wfw=="
        });
        console.log('[DevExpress] License configured');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // Load config.js with cache buster
        document.write('<script src="config.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
    </script>
</head>
<body>
    <header class="header">
        <button class="hamburger" id="hamburger">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
            <i class="fas fa-warehouse"></i>
            <span>WMS</span>
            <span id="app-version-badge" style="font-size: 9px; background: #4CAF50; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 8px; font-weight: 600;">Loading...</span>
        </div>
        <div class="module-buttons">
            <!-- Module buttons hidden - navigation handled by C# Form -->
        </div>
        <!-- User Info Panel with Logout -->
        <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem; background: #f8f9fa; padding: 0.75rem 1.25rem; border-radius: 10px; border: 2px solid #dee2e6;">
            <i class="fas fa-user-circle" style="font-size: 32px; color: #667eea;"></i>
            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span id="logged-in-username" style="font-weight: 700; font-size: 15px; color: #2d3748;"></span>
                    <span style="font-size: 11px; background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;" id="current-instance-display-mini"></span>
                </div>
                <span id="login-datetime" style="font-size: 11px; color: #888; margin-top: 2px;">Not logged in</span>
            </div>
            <button onclick="handleLogout()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        <div id="instance-selector" style="margin-left: 1rem; display: flex; align-items: center; gap: 0.5rem; background: #f8f9fa; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; border: 2px solid #dee2e6; transition: all 0.2s;" onclick="toggleInstanceMenu()">
            <i class="fas fa-server" style="color: #667eea;"></i>
            <span style="font-weight: 600; color: #2d3748; font-size: 14px;">Instance:</span>
            <span id="current-instance-display" style="font-weight: 700; color: #667eea; font-size: 14px;">PROD</span>
            <i class="fas fa-chevron-down" style="color: #667eea; font-size: 12px;"></i>
        </div>
        <!-- Instance Dropdown Menu -->
        <div id="instance-dropdown-menu" style="display: none; position: absolute; top: 60px; right: 20px; background: white; border: 2px solid #dee2e6; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; min-width: 150px;">
            <div class="instance-menu-item" data-instance="PROD" style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="selectInstance('PROD')">
                <i class="fas fa-check" id="check-PROD" style="color: #28a745; visibility: visible;"></i>
                <span style="font-weight: 600; color: #2d3748;">PROD</span>
            </div>
            <div class="instance-menu-item" data-instance="TEST" style="padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="selectInstance('TEST')">
                <i class="fas fa-check" id="check-TEST" style="color: #28a745; visibility: hidden;"></i>
                <span style="font-weight: 600; color: #2d3748;">TEST</span>
            </div>
        </div>
    </header>

    <!-- Fetch and display latest version from GitHub -->
    <script>
        (async function() {
            try {
                console.log('[Version Badge] Fetching latest version from GitHub API...');
                const response = await fetch('https://api.github.com/repos/javeedin/graysWMSwebviewnew/releases/latest');

                if (response.ok) {
                    const release = await response.json();
                    const version = release.tag_name || 'Unknown';
                    const badge = document.getElementById('app-version-badge');

                    if (badge) {
                        badge.textContent = version;
                        console.log('[Version Badge] Updated to:', version);
                    }
                } else {
                    console.warn('[Version Badge] Failed to fetch version:', response.status);
                    // Keep "Loading..." if fetch fails
                }
            } catch (error) {
                console.error('[Version Badge] Error fetching version:', error);
                // Keep "Loading..." if error occurs
            }
        })();
    </script>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="menu-item active" data-page="trip-management">
                <i class="fas fa-truck"></i>
                <span>Trip Management</span>
            </div>
            <div class="menu-item" data-page="vehicles">
                <i class="fas fa-car"></i>
                <span>Vehicles Dashboard</span>
            </div>
            <div class="menu-item" data-page="vehicle-management">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
            <div class="menu-item" data-page="vehicles-management">
                <i class="fas fa-truck"></i>
                <span>Vehicles</span>
            </div>
            <div class="menu-item" data-page="pickers-management">
                <i class="fas fa-users"></i>
                <span>Pickers</span>
            </div>
            <div class="menu-item" data-page="monitor-printing">
                <i class="fas fa-print"></i>
                <span>Monitor Printing</span>
            </div>
            <div class="menu-item" data-page="printer-setup-new">
                <i class="fas fa-print"></i>
                <span>Printer Setups</span>
            </div>
            <div class="menu-item" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>Settings & Updates</span>
            </div>
        </aside>
        
        <main class="main-content" id="main-content">
            <div id="trip-management" class="page-content">
                <div class="parameters-section">
                    <div class="parameters-header" id="parameters-toggle">
                        <h3>Query Parameters</h3>
                        <i class="fas fa-chevron-down collapse-icon" id="collapse-icon"></i>
                    </div>
                    <div class="parameters-content" id="parameters-content">
                        <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                            <label for="trip-instance-name">Instance Name</label>
                            <select id="trip-instance-name" class="form-control">
                                <option value="PROD">PROD</option>
                                <option value="TEST">TEST</option>
                                <option value="DEV">DEV</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 160px;">
                            <label for="trip-date-from">From Date</label>
                            <input type="date" id="trip-date-from" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 160px;">
                            <label for="trip-date-to">To Date</label>
                            <input type="date" id="trip-date-to" class="form-control">
                        </div>
                        <button id="fetch-trips-btn" class="btn" style="height: 34px;">
                            <i class="fas fa-sync-alt" id="fetch-icon"></i> 
                            <span id="fetch-text">Fetch Trips</span>
                        </button>
                    </div>
                </div>
                
                <div id="summary-stats" class="summary-stats" style="display: none;"></div>
                
                <div class="grid-container">
                    <div class="grid-header" style="padding: 0;">
                        <div id="trip-tab-header" class="tab-header" style="width: 100%;">
                            <div class="tab-item active" data-tab="all-trips">
                                <span>All Trips</span>
                            </div>
                        </div>
                    </div>
                    <div id="trip-tab-content" class="tab-content">
                        <div id="trip-all-trips-tab" class="tab-pane active">
                            <div class="filter-controls">
                                <div class="filter-group">
                                    <label>Filter Lorries</label>
                                    <div class="multi-select-dropdown" id="lorry-filter-dropdown">
                                        <button class="multi-select-button" type="button">
                                            <span id="lorry-filter-text">All Lorries</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="multi-select-dropdown-content" id="lorry-filter-content"></div>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label>Filter Dates</label>
                                    <div class="multi-select-dropdown" id="date-filter-dropdown">
                                        <button class="multi-select-button" type="button">
                                            <span id="date-filter-text">All Dates</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="multi-select-dropdown-content" id="date-filter-content"></div>
                                    </div>
                                </div>
                                <div style="margin-top: 1.2rem;">
                                    <button class="btn btn-secondary" id="clear-all-filters-btn">
                                        <i class="fas fa-times"></i> Clear Filters
                                    </button>
                                </div>
                            </div>
                            <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;">
                                <div class="grid-title">All Trips Data</div>
                                <div id="trip-count">0 trips</div>
                            </div>
                            <div id="trips-grid" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="vehicles" class="page-content" style="display: none;">
                <div class="grid-container" style="margin-top: 20px;">
                    <div class="grid-header" style="padding: 0;">
                        <div id="vehicles-tab-header" class="tab-header" style="width: 100%;">
                            <div class="tab-item active" data-tab="summary">
                                <span>Summary</span>
                            </div>
                            <div class="tab-item" data-tab="debug">
                                <span>Debug Data</span>
                            </div>
                        </div>
                    </div>
                    <div id="vehicles-tab-content" class="tab-content">
                        <div id="vehicles-summary-tab" class="tab-pane active">
                            <div class="summary-panel" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin: 1rem;">
                                <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                                    <label>Vehicle</label>
                                    <select id="vehicles-vehicle-filter" class="form-control">
                                        <option value="">All Vehicles</option>
                                    </select>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <label class="date-filter-label" style="display: block; margin-bottom: 0.5rem;">Filter by Date:</label>
                                    <div id="vehicles-date-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem;">
                                    <input type="checkbox" id="merge-dates-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                                    <label for="merge-dates-checkbox" style="cursor: pointer; font-weight: 600; color: var(--gray-700); margin: 0;">Merge Dates</label>
                                </div>
                            </div>
                            <div id="vehicles-cards-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 15px;">
                                <div class="loading"><i class="fas fa-circle-notch"></i><p>Loading vehicles...</p></div>
                            </div>
                        </div>
                        <div id="vehicles-debug-tab" class="tab-pane">
                            <div class="summary-panel">
                                <strong>Debug Information:</strong><br>
                                Total Records: <span id="debug-record-count">0</span><br>
                                Vehicle Count: <span id="debug-vehicle-count">0</span>
                            </div>
                            <div id="debug-data-container" style="padding: 15px;">
                                <div class="loading">Loading debug data...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="vehicle-management" class="page-content" style="display: none;">
                <!-- Analytics Dashboard -->
                <div id="analytics-dashboard" style="display: none;">
                    <!-- Filters Section -->
                    <div class="parameters-section" style="margin-bottom: 1.5rem;">
                        <div class="parameters-header">
                            <h3><i class="fas fa-filter"></i> Analytics Filters</h3>
                        </div>
                        <div class="parameters-content" style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                                <label for="analytics-date-from">From Date</label>
                                <input type="date" id="analytics-date-from" class="form-control">
                            </div>
                            <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                                <label for="analytics-date-to">To Date</label>
                                <input type="date" id="analytics-date-to" class="form-control">
                            </div>

                            <!-- Custom Filter Button: Customers -->
                            <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                                <label>Customers</label>
                                <button type="button" class="custom-filter-btn" id="customers-filter-btn">
                                    <span class="filter-text">All Customers</span>
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>

                            <!-- Custom Filter Button: Lorries -->
                            <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                                <label>Lorries</label>
                                <button type="button" class="custom-filter-btn" id="lorries-filter-btn">
                                    <span class="filter-text">All Lorries</span>
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>

                            <!-- Custom Filter Button: Pickers -->
                            <div class="form-group" style="margin-bottom: 0; min-width: 250px;">
                                <label>Pickers</label>
                                <button type="button" class="custom-filter-btn" id="pickers-filter-btn">
                                    <span class="filter-text">All Pickers</span>
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>

                            <button id="analytics-refresh-btn" class="btn" style="height: 34px; margin-top: 22px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button id="analytics-show-details-btn" class="btn" style="height: 34px; margin-top: 22px; background: #8b5cf6;">
                                <i class="fas fa-info-circle"></i> Show Details
                            </button>
                            <button id="analytics-clear-filters-btn" class="btn" style="height: 34px; margin-top: 22px; background: #f59e0b;">
                                <i class="fas fa-eraser"></i> Clear Filters
                            </button>
                            <button id="analytics-export-btn" class="btn" style="height: 34px; margin-top: 22px; background: #10b981;">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>

                        <!-- Selected Filters Display -->
                        <div id="analytics-selected-filters" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span style="font-weight: 600; color: #475569; font-size: 0.875rem;">Active Filters:</span>
                                <div id="analytics-filter-chips" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <!-- Filter chips added dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="analytics-kpis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Orders</div>
                            <div id="kpi-total-orders" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                        <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Trips</div>
                            <div id="kpi-total-trips" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                        <div class="kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Customers</div>
                            <div id="kpi-total-customers" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                        <div class="kpi-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Lorries</div>
                            <div id="kpi-total-lorries" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                        <div class="kpi-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Pickers</div>
                            <div id="kpi-total-pickers" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                        <div class="kpi-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Avg Orders/Trip</div>
                            <div id="kpi-avg-orders" style="font-size: 2rem; font-weight: 700;">0</div>
                        </div>
                    </div>

                    <!-- Charts Row 1: Daily, Weekly, Monthly Trends -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Daily Orders Trend</h3>
                            <canvas id="chart-orders-trend" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Weekly Orders Trend</h3>
                            <canvas id="chart-weekly-trend" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Charts Row 2: Monthly Trend & Status Distribution -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Monthly Orders Trend</h3>
                            <canvas id="chart-monthly-trend" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Status Distribution</h3>
                            <canvas id="chart-status-dist" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Charts Row 3 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Orders by Lorry</h3>
                            <canvas id="chart-orders-lorry" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Orders by Picker</h3>
                            <canvas id="chart-orders-picker" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Charts Row 3 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Top 10 Customers</h3>
                            <canvas id="chart-top-customers" style="max-height: 300px;"></canvas>
                        </div>
                        <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: #1e293b;">Total Weight by Lorry</h3>
                            <canvas id="chart-weight-lorry" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="analytics-empty-state" class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <h3>Analytics Dashboard</h3>
                    <p>Click "Fetch Trips" in Trip Management to load analytics data</p>
                    <button onclick="document.querySelector('[data-page=trip-management]').click()" class="btn" style="margin-top: 1rem;">
                        <i class="fas fa-arrow-left"></i> Go to Trip Management
                    </button>
                </div>

                <!-- Filter Modal: Customers -->
                <div class="filter-modal" id="customers-filter-modal" style="display: none;">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content">
                        <div class="filter-modal-header">
                            <h3><i class="fas fa-users"></i> Select Customers</h3>
                            <button type="button" class="filter-modal-close" data-modal="customers">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search customers..." id="customers-search" autocomplete="off">
                        </div>
                        <div class="filter-options" id="customers-options">
                            <!-- Options populated dynamically -->
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-action-btn select-all" data-filter="customers">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button type="button" class="filter-action-btn clear-all" data-filter="customers">
                                <i class="fas fa-times-circle"></i> Clear All
                            </button>
                            <button type="button" class="filter-action-btn apply-filter" data-modal="customers">
                                <i class="fas fa-check"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filter Modal: Lorries -->
                <div class="filter-modal" id="lorries-filter-modal" style="display: none;">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content">
                        <div class="filter-modal-header">
                            <h3><i class="fas fa-truck"></i> Select Lorries</h3>
                            <button type="button" class="filter-modal-close" data-modal="lorries">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search lorries..." id="lorries-search" autocomplete="off">
                        </div>
                        <div class="filter-options" id="lorries-options">
                            <!-- Options populated dynamically -->
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-action-btn select-all" data-filter="lorries">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button type="button" class="filter-action-btn clear-all" data-filter="lorries">
                                <i class="fas fa-times-circle"></i> Clear All
                            </button>
                            <button type="button" class="filter-action-btn apply-filter" data-modal="lorries">
                                <i class="fas fa-check"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filter Modal: Pickers -->
                <div class="filter-modal" id="pickers-filter-modal" style="display: none;">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content">
                        <div class="filter-modal-header">
                            <h3><i class="fas fa-user-check"></i> Select Pickers</h3>
                            <button type="button" class="filter-modal-close" data-modal="pickers">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search pickers..." id="pickers-search" autocomplete="off">
                        </div>
                        <div class="filter-options" id="pickers-options">
                            <!-- Options populated dynamically -->
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-action-btn select-all" data-filter="pickers">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button type="button" class="filter-action-btn clear-all" data-filter="pickers">
                                <i class="fas fa-times-circle"></i> Clear All
                            </button>
                            <button type="button" class="filter-action-btn apply-filter" data-modal="pickers">
                                <i class="fas fa-check"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Details Modal -->
                <div class="filter-modal" id="analytics-details-modal" style="display: none;">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content" style="max-width: 700px;">
                        <div class="filter-modal-header">
                            <h3><i class="fas fa-chart-bar"></i> Analytics Details</h3>
                            <button type="button" class="filter-modal-close" id="details-modal-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                            <div id="analytics-details-content">
                                <!-- Content populated dynamically -->
                            </div>
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-action-btn apply-filter" id="details-modal-ok" style="flex: 0 0 auto; min-width: 120px;">
                                <i class="fas fa-check"></i> OK
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicles Management Page -->
            <div id="vehicles-management" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">Vehicles Management</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="loadVehicles()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showAddVehicleModal()">
                            <i class="fas fa-plus"></i> Add Vehicle
                        </button>
                    </div>
                </div>

                <div class="grid-container">
                    <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div class="grid-title">All Vehicles</div>
                        <div id="vehicles-count-display" style="color: #666; font-size: 14px;">0 vehicles</div>
                    </div>
                    <div id="vehicles-grid" style="height: 600px;"></div>
                </div>
            </div>

            <!-- Pickers Management Page -->
            <div id="pickers-management" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">Pickers Management</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="loadPickers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showAddPickerModal()">
                            <i class="fas fa-plus"></i> Add Picker
                        </button>
                    </div>
                </div>

                <div class="grid-container">
                    <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div class="grid-title">All Pickers</div>
                        <div id="pickers-count-display" style="color: #666; font-size: 14px;">0 pickers</div>
                    </div>
                    <div id="pickers-grid" style="height: 600px;"></div>
                </div>
            </div>

            <!-- Trip Details Management Page -->
            <div id="trip-details-management" class="page-content" style="display: none;">
                <!-- Trip Header Card - Compact Version -->
                <div style="background: white; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #667eea;">
                    <div style="padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 44px; height: 44px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-truck" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <h2 style="margin: 0; font-size: 17px; color: #1f2937; font-weight: 600;">
                                    Trip #<span id="trip-detail-id">-</span>
                                </h2>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">
                                    <span id="trip-detail-status-badge" class="status-badge status-pending" style="font-size: 10px; padding: 2px 8px;">DRAFT</span>
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editTripDetails()" style="font-size: 13px; padding: 7px 14px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-secondary" onclick="goBackToTripManagement()" style="font-size: 13px; padding: 7px 14px;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                    <div style="padding: 1rem 1.5rem; background: #f9fafb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.65rem;">
                                <div style="width: 34px; height: 34px; background: #dbeafe; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-calendar" style="color: #2563eb; font-size: 13px;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">Trip Date</div>
                                    <div id="trip-detail-date" style="font-size: 13px; font-weight: 600; color: #1f2937;">-</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.65rem;">
                                <div style="width: 34px; height: 34px; background: #fef3c7; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-truck" style="color: #d97706; font-size: 13px;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">Vehicle</div>
                                    <div id="trip-detail-vehicle" style="font-size: 13px; font-weight: 600; color: #1f2937;">-</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.65rem;">
                                <div style="width: 34px; height: 34px; background: #dcfce7; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-warehouse" style="color: #16a34a; font-size: 13px;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">Loading Bay</div>
                                    <div id="trip-detail-loading-bay" style="font-size: 13px; font-weight: 600; color: #1f2937;">-</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.65rem;">
                                <div style="width: 34px; height: 34px; background: #fce7f3; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-flag" style="color: #db2777; font-size: 13px;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">Priority</div>
                                    <div id="trip-detail-priority" style="font-size: 13px; font-weight: 600; color: #1f2937;">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="grid-container">
                    <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div class="grid-title">Trip Orders</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <div id="trip-orders-count" style="color: #666; font-size: 14px; margin-right: 1rem;">0 orders</div>
                            <button class="btn btn-primary" onclick="openAddOrdersModal()">
                                <i class="fas fa-plus"></i> Add Orders
                            </button>
                        </div>
                    </div>
                    <div id="trip-orders-grid" style="height: 500px;"></div>
                </div>
            </div>

            <!-- Add Orders Modal -->
            <div id="add-orders-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 1200px; height: 90%; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            <i class="fas fa-box" style="color: #667eea;"></i>
                            Select Orders to Add to Trip
                        </h3>
                        <button onclick="closeAddOrdersModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
                    </div>

                    <!-- Search and Filter -->
                    <div style="padding: 1rem 1.5rem; background: #f8f9fa; border-bottom: 2px solid #f0f0f0;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                                <input type="text" id="orders-search" class="form-control" placeholder="Search orders...">
                            </div>
                            <button class="btn btn-info" onclick="openPasteOrdersPopup()" title="Paste multiple order numbers">
                                <i class="fas fa-paste"></i> Paste Orders
                            </button>
                            <button class="btn btn-secondary" onclick="loadPendingOrders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <div style="color: #666; font-size: 14px;">
                                <span id="pending-orders-count">0</span> pending orders
                            </div>
                        </div>
                    </div>

                    <!-- Orders Grid -->
                    <div style="flex: 1; overflow: hidden; padding: 1.5rem;">
                        <div id="pending-orders-grid" style="height: 100%;"></div>
                    </div>

                    <!-- Footer -->
                    <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666; font-size: 14px;">
                            Selected: <span id="selected-orders-count" style="font-weight: 700; color: #667eea;">0</span> orders
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="closeAddOrdersModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-primary" onclick="addSelectedOrdersToTrip()" id="add-orders-to-trip-btn">
                                <i class="fas fa-plus-circle"></i> Add to Trip
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paste Orders Popup -->
            <div id="paste-orders-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 800px; max-height: 80%; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            <i class="fas fa-paste" style="color: #17a2b8;"></i>
                            Paste Order Numbers
                        </h3>
                        <button onclick="closePasteOrdersPopup()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
                    </div>

                    <div style="padding: 1.5rem; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;">
                        <div style="color: #666; font-size: 14px; margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                            Paste order numbers below (one per line). Orders will be searched in the pending orders list.
                        </div>

                        <textarea id="paste-orders-textarea"
                                  placeholder="Paste order numbers here (one per line)&#10;&#10;Example:&#10;VVBG29029&#10;VVBG29028&#10;VVBG29026"
                                  style="flex: 1; min-height: 200px; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 14px; resize: vertical;"
                        ></textarea>

                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="searchPastedOrders()" style="flex: 1;">
                                <i class="fas fa-search"></i> Search Orders
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('paste-orders-textarea').value = ''">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>

                        <!-- Results Section -->
                        <div id="paste-orders-results" style="display: none; margin-top: 1rem;">
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="margin: 0; font-size: 16px; color: #333;">Search Results</h4>
                                    <div style="font-size: 14px; color: #666;">
                                        <span style="color: #28a745; font-weight: 700;"><i class="fas fa-check-circle"></i> <span id="found-count">0</span> Found</span>
                                        <span style="margin: 0 0.5rem;">|</span>
                                        <span style="color: #dc3545; font-weight: 700;"><i class="fas fa-times-circle"></i> <span id="not-found-count">0</span> Not Found</span>
                                    </div>
                                </div>
                                <div id="paste-orders-results-list" style="max-height: 250px; overflow-y: auto; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #e0e0e0;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="closePasteOrdersPopup()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" id="add-pasted-orders-btn" onclick="addPastedOrdersToTrip()" style="display: none;">
                            <i class="fas fa-plus-circle"></i> Add to Trip
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Trip Modal -->
            <div id="edit-trip-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            <i class="fas fa-edit" style="color: #667eea;"></i>
                            Edit Trip Details
                        </h3>
                        <button onclick="closeEditTripModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
                    </div>

                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="edit-trip-date">Trip Date *</label>
                                <input type="date" id="edit-trip-date" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="edit-trip-vehicle">Vehicle *</label>
                                <select id="edit-trip-vehicle" class="form-control" required>
                                    <option value="">Select Vehicle</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="edit-trip-priority">Priority *</label>
                                <select id="edit-trip-priority" class="form-control" required>
                                    <option value="">Select Priority</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-trip-loading-bay">Loading Bay *</label>
                                <select id="edit-trip-loading-bay" class="form-control" required>
                                    <option value="">Select Loading Bay</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="edit-trip-status">Status</label>
                            <select id="edit-trip-status" class="form-control">
                                <option value="DRAFT">DRAFT</option>
                                <option value="READY">READY</option>
                                <option value="IN_PROGRESS">IN PROGRESS</option>
                                <option value="COMPLETED">COMPLETED</option>
                                <option value="CANCELLED">CANCELLED</option>
                            </select>
                        </div>
                    </div>

                    <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="closeEditTripModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="updateTripDetails()" id="update-trip-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>

      <!-- ============================================================ -->
<!-- REPLACE THE ENTIRE <div id="monitor-printing"> SECTION -->
<!-- ============================================================ -->

<div id="monitor-printing" class="page-content" style="display: none;">
    <div style="margin-bottom: 1.5rem;">
        <!-- Search Parameters -->
        <div class="parameters-section">
            <div class="parameters-header" id="monitor-parameters-toggle">
                <h3>Query Parameters</h3>
                <i class="fas fa-chevron-down collapse-icon" id="monitor-collapse-icon"></i>
            </div>
            <div class="parameters-content" id="monitor-parameters-content">
                <div class="form-group" style="margin-bottom: 0; min-width: 160px;">
                    <label for="monitor-date-from">From Date</label>
                    <input type="date" id="monitor-date-from" class="form-control">
                </div>
                <div class="form-group" style="margin-bottom: 0; min-width: 160px;">
                    <label for="monitor-date-to">To Date</label>
                    <input type="date" id="monitor-date-to" class="form-control">
                </div>
                <button id="load-monitor-trips-btn" class="btn" style="height: 34px;" onclick="loadMonitoringTrips()">
                    <i class="fas fa-sync-alt" id="monitor-fetch-icon"></i>
                    <span id="monitor-fetch-text">Load Trips</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="print-stats-grid">
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-total-jobs">0</div>
            <div class="print-stat-label">Total Jobs</div>
        </div>
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-pending-download">0</div>
            <div class="print-stat-label">Pending Download</div>
        </div>
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-completed-download">0</div>
            <div class="print-stat-label">Downloaded</div>
        </div>
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-pending-print">0</div>
            <div class="print-stat-label">Pending Print</div>
        </div>
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-printed">0</div>
            <div class="print-stat-label">Printed</div>
        </div>
        <div class="print-stat-card">
            <div class="print-stat-value" id="stat-failed">0</div>
            <div class="print-stat-label">Failed</div>
        </div>
    </div>

    <!-- Tabs for Trips and Trip Details -->
    <div class="grid-container">
        <div class="grid-header" style="padding: 0;">
            <div id="monitor-tab-header" class="tab-header" style="width: 100%;">
                <div class="tab-item active" data-tab="trips" onclick="switchMonitorTab('trips')">
                    <span>Trips</span>
                </div>
                <div class="tab-item" data-tab="print-queue" onclick="switchMonitorTab('print-queue')">
                    <span><i class="fas fa-print"></i> Print Queue</span>
                </div>
                <!-- Trip detail tabs will be added dynamically here -->
            </div>
        </div>
        <div id="monitor-tab-content" class="tab-content">
            <!-- Tab 1: Trips List -->
            <div id="monitor-trips-tab" class="tab-pane active" data-tab-content="trips">
                <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div class="grid-title">Monitored Trips</div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="filtered-count" style="color: #666; font-size: 14px;">0 trips</div>
                    </div>
                </div>
                <div id="print-jobs-grid" style="height: 600px;"></div>
            </div>

            <!-- Tab 2: Print Queue -->
            <div id="monitor-print-queue-tab" class="tab-pane" data-tab-content="print-queue">
                <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div class="grid-title"><i class="fas fa-print"></i> Print Queue</div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="print-queue-count" style="color: #666; font-size: 14px;">0 jobs</div>
                        <button id="start-print-queue-btn" class="btn btn-success" onclick="processPrintQueue()" style="font-size: 12px; padding: 6px 16px;">
                            <i class="fas fa-play"></i> Start Printing
                        </button>
                        <button id="clear-print-queue-btn" class="btn btn-secondary" onclick="clearPrintQueue()" style="font-size: 12px; padding: 6px 16px;">
                            <i class="fas fa-trash"></i> Clear Queue
                        </button>
                    </div>
                </div>
                <div id="print-queue-grid" style="height: 600px;"></div>
            </div>

            <!-- Trip detail tab panes will be added dynamically here -->
        </div>
    </div>
</div>

<!-- PDF Preview Modal -->
<div id="pdf-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 1200px; height: 90%; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <!-- Modal Header -->
        <div style="padding: 1rem 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 18px; color: #333;">
                    <i class="fas fa-file-pdf" style="color: #dc3545;"></i> 
                    PDF Preview
                </h3>
                <p id="preview-order-info" style="margin: 5px 0 0 0; font-size: 13px; color: #666;"></p>
            </div>
            <button onclick="closePdfPreview()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                Ã—
            </button>
        </div>
        
        <!-- Modal Content -->
        <div style="flex: 1; overflow: hidden; position: relative; background: #f5f5f5;">
            <iframe id="pdf-preview-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
            <div id="pdf-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: #667eea;"></i>
                <p style="margin-top: 1rem; color: #666;">Loading PDF...</p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div id="preview-file-info" style="font-size: 13px; color: #666;"></div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closePdfPreview()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn btn-primary" onclick="downloadCurrentPdf()">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Printer Selection Modal for Auto-Print (FROM TRIP CARDS) -->
<div id="printer-selection-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0;">
            <h3 style="margin: 0; font-size: 18px; color: #333;">
                <i class="fas fa-print" style="color: #667eea;"></i> Select Printer for Auto-Print
            </h3>
            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">
                Choose a printer to automatically download and print documents
            </p>
        </div>

        <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-truck" style="color: #667eea;"></i> Trip ID
                </label>
                <div id="modal-trip-id" style="padding: 0.75rem; background: #f7fafc; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 600; color: #2d3748;"></div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-calendar" style="color: #667eea;"></i> Trip Date
                </label>
                <div id="modal-trip-date" style="padding: 0.75rem; background: #f7fafc; border-radius: 6px; color: #2d3748;"></div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-box" style="color: #667eea;"></i> Total Orders
                </label>
                <div id="modal-order-count" style="padding: 0.75rem; background: #f7fafc; border-radius: 6px; color: #2d3748;"></div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="modal-printer-select" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-print" style="color: #667eea;"></i> Select Printer <span style="color: #dc3545;">*</span>
                </label>
                <select id="modal-printer-select" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    <option value="">-- Loading printers... --</option>
                </select>
            </div>

            <div id="printer-selection-error" style="display: none; padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc3545; border-radius: 4px; margin-bottom: 1rem; color: #991b1b; font-size: 14px;"></div>
        </div>

        <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="closePrinterSelectionModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="confirmPrinterSelection()">
                <i class="fas fa-check"></i> Enable Auto-Print
            </button>
        </div>
    </div>
</div>

<!-- NEW: Printer Selection Modal for Print All (FROM MONITOR PRINTING) -->
<div id="print-all-printer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0;">
            <h3 style="margin: 0; font-size: 18px; color: #333;">
                <i class="fas fa-print" style="color: #28a745;"></i> Select Printer for Printing
            </h3>
            <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">
                Choose a printer to print the selected documents
            </p>
        </div>

        <div style="padding: 1.5rem;">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-truck" style="color: #28a745;"></i> Trip ID
                </label>
                <div id="print-modal-trip-id" style="padding: 0.75rem; background: #f7fafc; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 600; color: #2d3748;"></div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-box" style="color: #28a745;"></i> Orders to Print
                </label>
                <div id="print-modal-order-count" style="padding: 0.75rem; background: #f7fafc; border-radius: 6px; color: #2d3748;"></div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="print-modal-printer-select" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333; font-size: 14px;">
                    <i class="fas fa-print" style="color: #28a745;"></i> Select Printer <span style="color: #dc3545;">*</span>
                </label>
                <select id="print-modal-printer-select" class="form-control" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    <option value="">-- Loading printers... --</option>
                </select>
            </div>

            <div id="print-modal-error" style="display: none; padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc3545; border-radius: 4px; margin-bottom: 1rem; color: #991b1b; font-size: 14px;"></div>
        </div>

        <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="closePrintAllPrinterModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-success" onclick="confirmPrintAllWithPrinter()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>
</div>

            <div id="printer-setup" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="loadAllPrinters()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showAddPrinterModal()">
                            <i class="fas fa-plus"></i> Add Printer
                        </button>
                    </div>
                </div>

                <!-- Printers Table -->
                <div class="grid-container">
                    <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div class="grid-title">Configured Printers</div>
                        <div id="printer-count-display" style="color: #666; font-size: 14px;">0 printers</div>
                    </div>
                    <div id="printers-grid" style="height: 500px;"></div>
                </div>
            </div>

            <!-- Add/Edit Printer Modal -->
            <div id="printer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Modal Header -->
                    <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            <i class="fas fa-printer"></i>
                            <span id="printer-modal-title">Add New Printer</span>
                        </h3>
                        <button onclick="closePrinterModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
                    </div>

                    <!-- Modal Content -->
                    <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                        <input type="hidden" id="edit-printer-id">

                        <div class="form-group">
                            <label for="modal-printer-select">Printer Name *</label>
                            <select id="modal-printer-select" class="form-control">
                                <option value="">Select a printer...</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="modal-paper-size">Paper Size</label>
                                <select id="modal-paper-size" class="form-control">
                                    <option value="A4">A4</option>
                                    <option value="Letter">Letter</option>
                                    <option value="Legal">Legal</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="modal-orientation">Orientation</label>
                                <select id="modal-orientation" class="form-control">
                                    <option value="Portrait">Portrait</option>
                                    <option value="Landscape">Landscape</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="modal-fusion-instance">Fusion Instance *</label>
                            <select id="modal-fusion-instance" class="form-control">
                                <option value="TEST">TEST</option>
                                <option value="PROD">PROD</option>
                                <option value="DEV">DEV</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="modal-fusion-username">Fusion Username *</label>
                            <input type="text" id="modal-fusion-username" class="form-control" placeholder="Enter username">
                        </div>

                        <div class="form-group">
                            <label for="modal-fusion-password">Fusion Password *</label>
                            <input type="password" id="modal-fusion-password" class="form-control" placeholder="Enter password">
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modal-auto-download" checked style="width: 18px; height: 18px;">
                                <span>Auto-download PDFs when auto-print is enabled</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modal-auto-print" checked style="width: 18px; height: 18px;">
                                <span>Auto-print PDFs after download</span>
                            </label>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="closePrinterModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="savePrinterFromModal()">
                            <i class="fas fa-save"></i> Save Printer
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW PRINTER SETUP PAGE -->
            <div id="printer-setup-new" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="loadAllPrintersNew()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showAddPrinterModalNew()">
                            <i class="fas fa-plus"></i> Add Printer
                        </button>
                    </div>
                </div>

                <!-- Printers Table -->
                <div class="grid-container">
                    <div style="padding: 1rem 1.5rem; background: white; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <div class="grid-title">Configured Printers (NEW VERSION)</div>
                        <div id="printer-count-display-new" style="color: #666; font-size: 14px;">0 printers</div>
                    </div>
                    <div id="printers-grid-new" style="height: 500px;"></div>
                </div>
            </div>

            <!-- Add/Edit Printer Modal (NEW) -->
            <div id="printer-modal-new" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Modal Header -->
                    <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px; color: #333;">
                            <i class="fas fa-printer"></i>
                            <span id="printer-modal-title-new">Add New Printer</span>
                        </h3>
                        <button onclick="closePrinterModalNew()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
                    </div>

                    <!-- Modal Content -->
                    <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                        <input type="hidden" id="edit-printer-id-new">

                        <div class="form-group">
                            <label for="modal-printer-select-new">Printer Name *</label>
                            <select id="modal-printer-select-new" class="form-control">
                                <option value="">Select a printer...</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="modal-printer-ip-new">IP Address</label>
                                <input type="text" id="modal-printer-ip-new" class="form-control" placeholder="e.g., 192.168.1.100">
                                <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;">Optional: Network printer IP</small>
                            </div>

                            <div class="form-group">
                                <label for="modal-printer-short-name-new">Short Name *</label>
                                <input type="text" id="modal-printer-short-name-new" class="form-control" placeholder="e.g., GROM-02">
                                <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;">Required: Display name</small>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="modal-paper-size-new">Paper Size</label>
                                <select id="modal-paper-size-new" class="form-control">
                                    <option value="A4">A4</option>
                                    <option value="Letter">Letter</option>
                                    <option value="Legal">Legal</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="modal-orientation-new">Orientation</label>
                                <select id="modal-orientation-new" class="form-control">
                                    <option value="Portrait">Portrait</option>
                                    <option value="Landscape">Landscape</option>
                                </select>
                            </div>
                        </div>

                        <!-- Printer Discovery Section -->
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #667eea;">
                            <label style="font-weight: 600; color: #333; margin-bottom: 0.5rem; display: block;">
                                <i class="fas fa-search"></i> Discover Printers
                            </label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="discoverBluetoothPrinters()" style="flex: 1; min-width: 140px;">
                                    <i class="fab fa-bluetooth"></i> Bluetooth Printers
                                </button>
                                <button class="btn btn-secondary" onclick="discoverWifiPrinters()" style="flex: 1; min-width: 140px;">
                                    <i class="fas fa-wifi"></i> WiFi Printers
                                </button>
                            </div>
                            <small style="color: #666; font-size: 11px; margin-top: 6px; display: block;">
                                Click to search for available Bluetooth or WiFi printers on your network
                            </small>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modal-auto-download-new" checked style="width: 18px; height: 18px;">
                                <span>Auto-download PDFs when auto-print is enabled</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="modal-auto-print-new" checked style="width: 18px; height: 18px;">
                                <span>Auto-print PDFs after download</span>
                            </label>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: space-between; gap: 0.5rem;">
                        <div>
                            <button class="btn btn-secondary" onclick="testCurrentPrinterSelection()" style="background: #17a2b8; border-color: #17a2b8;">
                                <i class="fas fa-print"></i> Test Printer
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="closePrinterModalNew()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-primary" onclick="savePrinterFromModalNew()">
                                <i class="fas fa-save"></i> Save Printer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings & Updates Page -->
            <div id="settings" class="page-content" style="display: none;">
                <div class="grid-container" style="max-width: 800px; margin: 0 auto;">
                    <!-- Application Information -->
                    <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h3 style="margin-top: 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #4CAF50;"></i>
                            Application Information
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Current Version:</span>
                                <strong id="current-version-display" style="color: #333;">Loading...</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Build Date:</span>
                                <strong id="build-date-display" style="color: #333;">Loading...</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: #666;">Update Status:</span>
                                <strong id="update-status-display" style="color: #4CAF50;">Checking...</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Update Settings -->
                    <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h3 style="margin-top: 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-sync-alt" style="color: #2196F3;"></i>
                            Update Settings
                        </h3>
                        <div style="display: grid; gap: 1.5rem;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="auto-update-html-checkbox" checked>
                                    <span>Automatically download HTML/JS updates</span>
                                </label>
                                <p style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; color: #666;">
                                    Updates will be applied on next restart
                                </p>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="check-updates-on-start-checkbox" checked>
                                    <span>Check for updates on startup</span>
                                </label>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #666;">
                                    Update check interval (minutes):
                                </label>
                                <input type="number" id="update-interval-input" value="60" min="15" max="1440"
                                       style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="saveUpdateSettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Update Actions -->
                    <div style="background: white; padding: 2rem; border-radius: 12px;">
                        <h3 style="margin-top: 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-cloud-download-alt" style="color: #FF9800;"></i>
                            Update Actions
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <button class="btn btn-primary" onclick="manualCheckForUpdates()" style="width: 100%; justify-content: center;">
                                <i class="fas fa-sync-alt"></i> Check for Updates Now
                            </button>
                            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196F3;">
                                <p style="margin: 0; font-size: 0.875rem; color: #666;">
                                    <strong>Last checked:</strong> <span id="last-update-check-time">Never</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicle-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; color: #333;">
                    <i class="fas fa-truck"></i>
                    <span id="vehicle-modal-title">Add New Vehicle</span>
                </h3>
                <button onclick="closeVehicleModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
            </div>

            <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="edit-vehicle-id">

                <div class="form-group">
                    <label for="modal-lorry-number">Lorry Number *</label>
                    <input type="text" id="modal-lorry-number" class="form-control" placeholder="Enter lorry number">
                </div>

                <div class="form-group">
                    <label for="modal-assigned-route">Assigned Route</label>
                    <input type="text" id="modal-assigned-route" class="form-control" placeholder="Enter assigned route">
                </div>

                <div class="form-group">
                    <label for="modal-delivery-officer">Delivery Officer</label>
                    <input type="text" id="modal-delivery-officer" class="form-control" placeholder="Enter delivery officer name">
                </div>

                <div class="form-group">
                    <label for="modal-capacity">Capacity</label>
                    <input type="number" id="modal-capacity" class="form-control" placeholder="Enter capacity">
                </div>

                <div class="form-group">
                    <label for="modal-vehicle-status">Status</label>
                    <select id="modal-vehicle-status" class="form-control">
                        <option value="">Select Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
            </div>

            <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closeVehicleModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="saveVehicle()">
                    <i class="fas fa-save"></i> Save Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Picker Modal -->
    <div id="picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; color: #333;">
                    <i class="fas fa-user"></i>
                    <span id="picker-modal-title">Add New Picker</span>
                </h3>
                <button onclick="closePickerModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
            </div>

            <div style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="edit-picker-id">

                <div class="form-group">
                    <label for="modal-picker-name">Name *</label>
                    <input type="text" id="modal-picker-name" class="form-control" placeholder="Enter picker name">
                </div>

                <div class="form-group">
                    <label for="modal-picker-type">Picker Type *</label>
                    <select id="modal-picker-type" class="form-control">
                        <option value="">Select Type</option>
                        <option value="Bulk">Bulk</option>
                        <option value="Individual">Individual</option>
                        <option value="Express">Express</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="modal-picker-contact">Contact</label>
                    <input type="text" id="modal-picker-contact" class="form-control" placeholder="Enter contact">
                </div>

                <div class="form-group">
                    <label for="modal-picker-assigned-area">Assigned Area</label>
                    <input type="text" id="modal-picker-assigned-area" class="form-control" placeholder="Enter assigned area">
                </div>

                <div class="form-group">
                    <label for="modal-picker-profit-center">Profit Center</label>
                    <input type="text" id="modal-picker-profit-center" class="form-control" placeholder="Enter profit center">
                </div>

                <div class="form-group">
                    <label for="modal-picker-category">Category</label>
                    <input type="text" id="modal-picker-category" class="form-control" placeholder="Enter category">
                </div>
            </div>

            <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closePickerModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="savePicker()">
                    <i class="fas fa-save"></i> Save Picker
                </button>
            </div>
        </div>
    </div>

    <!-- New Trip Modal -->
    <div id="new-trip-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 1.5rem; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; color: #333;">
                    <i class="fas fa-plus-circle" style="color: #667eea;"></i>
                    Create New Trip
                </h3>
                <button onclick="closeNewTripModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">Ã—</button>
            </div>

            <!-- Loading Status -->
            <div id="new-trip-loading" style="display: none; padding: 2rem; text-align: center;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: #667eea;"></i>
                <p style="margin-top: 1rem; color: #666; font-size: 16px;" id="loading-status-text">Preparing form...</p>
                <div style="margin-top: 1rem;">
                    <div id="vehicles-status" style="color: #666; font-size: 14px; margin: 5px 0;">
                        <i class="fas fa-circle-notch fa-spin"></i> Loading vehicles...
                    </div>
                    <div id="pickers-status" style="color: #666; font-size: 14px; margin: 5px 0;">
                        <i class="fas fa-circle-notch fa-spin"></i> Loading pickers...
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <div id="new-trip-form-content" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
                <div class="form-group">
                    <label for="new-trip-id">Trip ID *</label>
                    <input type="text" id="new-trip-id" class="form-control" placeholder="Auto-generated or enter Trip ID" readonly style="background: #f5f5f5;">
                    <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">Trip ID will be auto-generated</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="new-trip-date">Trip Date *</label>
                        <input type="date" id="new-trip-date" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="new-trip-cost-date">Trip Cost Date *</label>
                        <input type="date" id="new-trip-cost-date" class="form-control" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="new-trip-vehicle">Vehicle *</label>
                        <select id="new-trip-vehicle" class="form-control" required>
                            <option value="">Select Vehicle</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="new-trip-picker">Picker *</label>
                        <select id="new-trip-picker" class="form-control" required>
                            <option value="">Select Picker</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="new-trip-priority">Priority *</label>
                        <select id="new-trip-priority" class="form-control" required>
                            <option value="">Select Priority</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="new-trip-loading-bay">Loading Bay *</label>
                        <select id="new-trip-loading-bay" class="form-control" required>
                            <option value="">Select Loading Bay</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="new-trip-notes">Notes (Optional)</label>
                    <textarea id="new-trip-notes" class="form-control" rows="3" placeholder="Enter any additional notes or instructions..."></textarea>
                </div>
            </div>

            <div style="padding: 1rem 1.5rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closeNewTripModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="createNewTrip()" id="create-trip-btn">
                    <i class="fas fa-plus-circle"></i> Create Trip
                </button>
            </div>
        </div>
    </div>

    <!-- WMS Co-Pilot -->
    <div id="copilot-fab" class="copilot-fab" onclick="toggleCopilot()" title="WMS Co-Pilot (Alt+C)">
        <i class="fas fa-robot"></i>
    </div>

    <div id="copilot-overlay" class="copilot-overlay" onclick="toggleCopilot()"></div>

    <div id="copilot-panel" class="copilot-panel">
        <!-- Header -->
        <div class="copilot-header">
            <h3><i class="fas fa-robot"></i> WMS Co-Pilot</h3>
            <button onclick="toggleCopilot()" class="copilot-close"><i class="fas fa-times"></i></button>
        </div>

        <!-- Tabs -->
        <div class="copilot-tabs">
            <div class="copilot-tab active" data-tab="actions" onclick="switchCopilotTab('actions')">
                <i class="fas fa-bolt"></i> Quick Actions
            </div>
            <div class="copilot-tab" data-tab="chat" onclick="switchCopilotTab('chat')">
                <i class="fas fa-comments"></i> Chat
            </div>
        </div>

        <!-- Tab Content: Quick Actions -->
        <div id="copilot-actions-content" class="copilot-tab-content active">
            <div class="copilot-section">
                <div class="copilot-section-title">
                    <i class="fas fa-zap"></i> Quick Actions
                </div>
                <div class="copilot-action" onclick="copilotAction('createTrip', 'Create New Trip')">
                    <i class="fas fa-plus-circle"></i>
                    <span>Create New Trip</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('addToTrip', 'Add to Trip')">
                    <i class="fas fa-box"></i>
                    <span>Add to Trip</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('printOrder', 'Print Order')">
                    <i class="fas fa-print"></i>
                    <span>Print Order</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('searchTransaction', 'Search Transaction')">
                    <i class="fas fa-search"></i>
                    <span>Search Transaction</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('printTrip', 'Print/Search Trip')">
                    <i class="fas fa-file-pdf"></i>
                    <span>Print/Search Trip</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('autoSchedule', 'Auto Schedule')">
                    <i class="fas fa-magic"></i>
                    <span>Auto Schedule</span>
                </div>
                <div class="copilot-action" onclick="copilotAction('optimizeRoute', 'Optimize Route')">
                    <i class="fas fa-route"></i>
                    <span>Optimize Route</span>
                </div>
            </div>

            <div class="copilot-section">
                <div class="copilot-section-title">
                    <i class="fas fa-lightbulb"></i> Need Help?
                </div>
                <div class="copilot-help-text">
                    Use the <strong>Chat</strong> tab to ask me anything about trip management, printing, or scheduling!
                </div>
            </div>
        </div>

        <!-- Tab Content: Chat -->
        <div id="copilot-chat-content" class="copilot-tab-content">
            <!-- Prompt Suggestions -->
            <div class="copilot-prompts">
                <div class="copilot-prompt" onclick="usePrompt('How do I create a new trip?')">
                    How do I create a new trip?
                </div>
                <div class="copilot-prompt" onclick="usePrompt('Print all orders for today')">
                    Print all orders for today
                </div>
                <div class="copilot-prompt" onclick="usePrompt('Optimize route for Trip 123')">
                    Optimize route for Trip 123
                </div>
                <div class="copilot-prompt" onclick="usePrompt('Help me with auto-scheduling')">
                    Help me with auto-scheduling
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="copilot-chat-messages" class="copilot-chat-messages">
                <!-- Messages will be added dynamically -->
            </div>

            <!-- Chat Input -->
            <div class="copilot-chat-input-container">
                <input
                    type="text"
                    id="copilot-chat-input"
                    class="copilot-chat-input"
                    placeholder="Ask me anything..."
                    autocomplete="off"
                />
                <button onclick="sendCopilotMessage()" class="copilot-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Diagnostic Toolbar (Bottom) -->
    <div id="diagnostic-toolbar" style="position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: white; padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); font-size: 12px;">
        <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-download-version" disabled onclick="if(typeof downloadNewVersion === 'function') { downloadNewVersion(); } else { console.error('downloadNewVersion function not loaded!'); alert('Distribution manager not loaded. Please refresh the page.'); }" class="btn btn-sm" style="background: #4CAF50; color: white; border: 1px solid #45a049; padding: 4px 10px; font-size: 11px; font-weight: 600; opacity: 0.6;">
                <i class="fas fa-download"></i> Get New Version
            </button>
            <button onclick="showPrinterQueue()" class="btn btn-sm" style="background: #667eea; color: white; border: 1px solid #5568d3; padding: 4px 10px; font-size: 11px; font-weight: 600;">
                <i class="fas fa-print"></i> Printer Queue
            </button>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
            <span id="code-version-indicator" style="background: #4CAF50; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-check-circle"></i> Latest Code: v2025.11.21-12 (Fix: Make openTripDetailsWithData Global)
            </span>
            <span id="diagnostic-status" style="color: #00ff88;">Ready</span>
            <button onclick="toggleDiagnosticToolbar()" class="btn btn-sm" style="background: #dc3545; color: white; padding: 4px 10px; font-size: 11px;">
                Hide
            </button>
        </div>
    </div>

    <!-- Dynamic cache busting - Load scripts synchronously to ensure DOMContentLoaded fires -->
    <script>
        // Load JavaScript files synchronously with cache buster
        console.log('[Cache Buster] Loading scripts synchronously with timestamp:', window.APP_CACHE_BUSTER);

        // Use document.write to load synchronously (ensures scripts execute BEFORE DOMContentLoaded)
        document.write('<script src="app.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="printer-management-new.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="monitor-printing.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="monitor-printing-print-all-modal.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="update-manager.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="distribution-manager.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="copilot.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="vehicles.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="pickers.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
        document.write('<script src="trip-details.js?v=' + window.APP_CACHE_BUSTER + '"><\/script>');
    </script>

    <!-- Login Session Handler -->
    <script>
        // Function to set logged-in username
        window.setLoggedInUser = function(username, instance, loginDateTime) {
            console.log('[LOGIN] Setting logged-in user:', username, 'Instance:', instance, 'DateTime:', loginDateTime);

            // Update username display
            const usernameElement = document.getElementById('logged-in-username');
            if (usernameElement) {
                usernameElement.textContent = username;
                console.log('[LOGIN] Username updated in UI');
            }

            // Update instance display in both places
            const instanceElement = document.getElementById('current-instance-display');
            if (instanceElement) {
                instanceElement.textContent = instance;
                console.log('[LOGIN] Instance dropdown updated in UI');
            }

            const instanceElementMini = document.getElementById('current-instance-display-mini');
            if (instanceElementMini) {
                instanceElementMini.textContent = instance;
                console.log('[LOGIN] Instance badge updated in UI');
            }

            // Update instance checkmarks
            updateInstanceCheckmarks(instance);

            // Update login date/time display
            const loginDateTimeElement = document.getElementById('login-datetime');
            if (loginDateTimeElement) {
                if (loginDateTime) {
                    loginDateTimeElement.textContent = loginDateTime;
                } else {
                    // If no loginDateTime provided, use current date/time
                    const now = new Date();
                    const formattedDateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                    loginDateTimeElement.textContent = 'Logged in: ' + formattedDateTime;
                }
                console.log('[LOGIN] Login date/time updated in UI');
            }

            // Store in session storage
            sessionStorage.setItem('loggedInUsername', username);
            sessionStorage.setItem('loggedInInstance', instance);
            sessionStorage.setItem('loggedInDateTime', loginDateTime || new Date().toISOString());

            // Update URL query parameter with instance
            const url = new URL(window.location.href);
            url.searchParams.set('instance', instance);
            window.history.pushState({}, '', url);
            console.log('[LOGIN] Updated URL with instance:', instance);
        };

        // Toggle instance dropdown menu
        window.toggleInstanceMenu = function() {
            const dropdown = document.getElementById('instance-dropdown-menu');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        };

        // Update instance checkmarks in dropdown
        window.updateInstanceCheckmarks = function(instance) {
            // Hide all checkmarks
            const checkProd = document.getElementById('check-PROD');
            const checkTest = document.getElementById('check-TEST');

            if (checkProd) checkProd.style.visibility = 'hidden';
            if (checkTest) checkTest.style.visibility = 'hidden';

            // Show checkmark for selected instance
            const checkElement = document.getElementById('check-' + instance);
            if (checkElement) {
                checkElement.style.visibility = 'visible';
            }
        };

        // Handle instance selection from dropdown
        window.selectInstance = function(instance) {
            console.log('[INSTANCE] Switching to:', instance);

            // Update both instance displays
            const instanceElement = document.getElementById('current-instance-display');
            if (instanceElement) {
                instanceElement.textContent = instance;
            }

            const instanceElementMini = document.getElementById('current-instance-display-mini');
            if (instanceElementMini) {
                instanceElementMini.textContent = instance;
            }

            // Update checkmarks
            updateInstanceCheckmarks(instance);

            // Save to session
            sessionStorage.setItem('loggedInInstance', instance);

            // Update URL query parameter
            const url = new URL(window.location.href);
            url.searchParams.set('instance', instance);
            window.history.pushState({}, '', url);
            console.log('[INSTANCE] Updated URL with instance:', instance);

            // Close dropdown
            const dropdown = document.getElementById('instance-dropdown-menu');
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            // Show success message
            showMessage('Switched to ' + instance + ' instance', 'success');
        };

        // Handle logout
        window.handleLogout = function() {
            console.log('[LOGOUT] User logging out...');

            // Clear session storage
            sessionStorage.removeItem('loggedInUsername');
            sessionStorage.removeItem('loggedInInstance');
            sessionStorage.removeItem('loggedInDateTime');

            // Reset UI to default state
            const usernameElement = document.getElementById('logged-in-username');
            if (usernameElement) {
                usernameElement.textContent = '';
            }

            const loginDateTimeElement = document.getElementById('login-datetime');
            if (loginDateTimeElement) {
                loginDateTimeElement.textContent = 'Not logged in';
            }

            const instanceElement = document.getElementById('current-instance-display');
            if (instanceElement) {
                instanceElement.textContent = 'PROD';
            }

            const instanceElementMini = document.getElementById('current-instance-display-mini');
            if (instanceElementMini) {
                instanceElementMini.textContent = '';
            }

            // Reset checkmarks to PROD
            updateInstanceCheckmarks('PROD');

            // Notify C# WebView to clear session
            if (typeof window.chrome !== 'undefined' && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    action: 'logout'
                });
                console.log('[LOGOUT] Logout message sent to C#');
            }

            console.log('[LOGOUT] Logout completed');

            // Show logout confirmation
            showMessage('Logged out successfully', 'success');
        };

        // Listen for messages from C# WebView2
        if (typeof window.chrome !== 'undefined' && window.chrome.webview) {
            window.chrome.webview.addEventListener('message', function(event) {
                console.log('[LOGIN] Received WebView message:', event.data);

                if (event.data && event.data.action === 'setUserSession') {
                    setLoggedInUser(event.data.username, event.data.instance, event.data.loginDateTime);
                }
            });
            console.log('[LOGIN] WebView2 message listener registered');
        }

        // On page load, restore from session storage or URL parameter
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL query parameter for instance first
            const urlParams = new URLSearchParams(window.location.search);
            const urlInstance = urlParams.get('instance');

            const savedUsername = sessionStorage.getItem('loggedInUsername');
            const savedInstance = sessionStorage.getItem('loggedInInstance');
            const savedDateTime = sessionStorage.getItem('loggedInDateTime');

            // Use URL instance if available, otherwise use saved instance
            const instanceToUse = urlInstance || savedInstance;

            if (instanceToUse) {
                // Update instance displays
                const instanceElement = document.getElementById('current-instance-display');
                if (instanceElement) {
                    instanceElement.textContent = instanceToUse;
                }

                const instanceElementMini = document.getElementById('current-instance-display-mini');
                if (instanceElementMini && savedUsername) {
                    instanceElementMini.textContent = instanceToUse;
                }

                // Update checkmarks
                updateInstanceCheckmarks(instanceToUse);

                // Update session storage if URL had instance
                if (urlInstance) {
                    sessionStorage.setItem('loggedInInstance', urlInstance);
                    console.log('[INSTANCE] Loaded from URL:', urlInstance);
                }
            }

            if (savedUsername && instanceToUse) {
                console.log('[LOGIN] Restoring session:', savedUsername, instanceToUse, savedDateTime);
                // Format saved date/time for display
                let formattedDateTime = 'Not logged in';
                if (savedDateTime) {
                    const loginDate = new Date(savedDateTime);
                    formattedDateTime = 'Logged in: ' + loginDate.toLocaleDateString() + ' ' + loginDate.toLocaleTimeString();
                }
                setLoggedInUser(savedUsername, instanceToUse, formattedDateTime);
            } else if (instanceToUse) {
                // No user logged in, but instance in URL - just update displays
                console.log('[INSTANCE] Setting instance from URL (no user logged in):', instanceToUse);
            }
        });

        console.log('[LOGIN] Session handler initialized');
    </script>
</body>
</html>